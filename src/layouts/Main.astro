---
import AppWindow from "lucide-astro/AppWindow";
import Gamepad2 from "lucide-astro/Gamepad2";
import LayoutGrid from "lucide-astro/LayoutGrid";
import Menu from "lucide-astro/Menu";
import Settings2 from "lucide-astro/Settings2";
import X from "lucide-astro/X";

import Layout from "@/layouts/Layout.astro";

const navLinks = [
  { href: "/games", text: "Games", Icon: Gamepad2 },
  { href: "/apps", text: "Apps", Icon: LayoutGrid },
  { href: "/tabs", text: "Tabs", Icon: AppWindow },
  { href: "/settings", text: "Settings", Icon: Settings2 },
];
---

<Layout>
  <nav
    id="default-nav"
    class="fixed top-0 left-0 right-0 z-[99999] flex items-center justify-between px-5 py-3 bg-background/90 backdrop-blur-md border-b border-white/10"
  >
    <a
      href="/"
      class="text-3xl font-bold text-text hover:text-accent transition-colors tracking-tighter"
    >
      IN
    </a>

    <div id="nav-links" class="hidden items-center gap-2">
      {
        navLinks.map((link) => (
          <a
            href={link.href}
            class="inline-flex items-center gap-2 rounded px-3 py-1.5 text-sm text-text-secondary hover:text-text hover:bg-white/10 transition-all"
          >
            <link.Icon class="w-4 h-4" strokeWidth={1.5} />
            <span>{link.text}</span>
          </a>
        ))
      }
    </div>

    <button
      id="menu-toggle"
      class="p-2 text-text-secondary hover:text-text transition-colors"
      aria-label="Toggle menu"
    >
      <Menu id="menu-icon" class="w-6 h-6 transition-transform duration-200" strokeWidth={1.5} />
      <X id="close-icon" class="w-6 h-6 hidden transition-transform duration-200" strokeWidth={1.5} />
    </button>
  </nav>

  <div
    id="nav-menu"
    class="fixed top-14 right-4 z-[99998] min-w-[180px] bg-background/95 backdrop-blur-sm border border-white/10 p-2 shadow-2xl origin-top-right transition-all duration-200 ease-out opacity-0 scale-95 pointer-events-none"
  >
    {
      navLinks.map((link, i) => (
        <a
          href={link.href}
          class="menu-item flex items-center gap-3 px-3 py-2.5 text-text-secondary hover:text-text hover:bg-white/10 transition-all duration-150"
          style={`transition-delay: ${i * 30}ms;`}
        >
          <link.Icon class="w-4 h-4" strokeWidth={1.5} />
          <span class="text-sm">{link.text}</span>
        </a>
      ))
    }
  </div>

  <main class="flex flex-col min-h-screen pt-14">
    <slot />
  </main>
</Layout>

<style>
  #nav-menu.open {
    opacity: 1;
    transform: scale(1);
    pointer-events: auto;
  }

  #nav-menu .menu-item {
    opacity: 0;
    transform: translateX(10px);
  }

  #nav-menu.open .menu-item {
    opacity: 1;
    transform: translateX(0);
  }
</style>

<script>
  function getId(name: string): string {
    const codeMap = (window as Window & { _2?: Record<string, string> })._2;
    return codeMap?.[name] ?? name;
  }

  document.addEventListener("astro:page-load", () => {
    const navStyle = localStorage.getItem("nav-style") || "inline";
    const toggle = document.getElementById(getId("menu-toggle"));
    const menu = document.getElementById(getId("nav-menu"));
    const links = document.getElementById(getId("nav-links"));
    const openIcon = document.getElementById(getId("menu-icon"));
    const closeIcon = document.getElementById(getId("close-icon"));

    if (!toggle || !menu || !openIcon || !closeIcon) return;

    if (navStyle === "inline") {
      links?.classList.remove("hidden");
      toggle.classList.add("hidden");
      menu.classList.remove("open");
      menu.classList.add("hidden");
      return;
    }

    links?.classList.add("hidden");
    menu.classList.remove("hidden");

    const open = () => {
      menu.classList.add("open");
      openIcon.classList.add("hidden");
      closeIcon.classList.remove("hidden");
    };

    const close = () => {
      menu.classList.remove("open");
      openIcon.classList.remove("hidden");
      closeIcon.classList.add("hidden");
    };

    toggle.addEventListener("click", () => {
      menu.classList.contains("open") ? close() : open();
    });

    document.addEventListener("click", (e) => {
      if (!toggle.contains(e.target as Node) && !menu.contains(e.target as Node)) {
        close();
      }
    });
  });
</script>
